<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        .token { background: #f5f5f5; padding: 10px; margin: 10px 0; word-break: break-all; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>Firebase Auth Test</h1>
    <p>Use this page to get Firebase ID tokens for testing your backend API.</p>
    
    <div>
        <h3>1. Configure Firebase</h3>
        <p>Replace the firebaseConfig below with your actual Firebase config:</p>
        <textarea id="config" rows="8" cols="60" placeholder="Paste your Firebase config here...">{
  "apiKey": "your-api-key",
  "authDomain": "your-project.firebaseapp.com", 
  "projectId": "your-project-id",
  "storageBucket": "your-project.appspot.com",
  "messagingSenderId": "123456789",
  "appId": "your-app-id"
}</textarea>
        <br>
        <button onclick="initFirebase()">Initialize Firebase</button>
        <div id="initStatus"></div>
    </div>

    <div>
        <h3>2. Sign In</h3>
        <button onclick="signInWithGoogle()">Sign in with Google</button>
        <button onclick="signInWithFacebook()">Sign in with Facebook</button>
        <button onclick="signInWithPhone()">Sign in with Phone</button>
        <div id="authStatus"></div>
    </div>

    <div>
        <h3>3. Get ID Token</h3>
        <button onclick="getIdToken()">Get ID Token</button>
        <button onclick="copyToken()">Copy Token</button>
        <div id="tokenDisplay" class="token" style="display: none;"></div>
    </div>

    <div>
        <h3>4. Test Backend</h3>
        <button onclick="testBackend()">Test Backend API</button>
        <div id="backendStatus"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, FacebookAuthProvider, signInWithPhoneNumber, RecaptchaVerifier } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        let app, auth, currentUser;

        window.initFirebase = function() {
            try {
                const configText = document.getElementById('config').value;
                const config = JSON.parse(configText);
                
                app = initializeApp(config);
                auth = getAuth(app);
                
                document.getElementById('initStatus').innerHTML = '<div class="success">✅ Firebase initialized successfully!</div>';
                
                // Listen for auth state changes
                auth.onAuthStateChanged((user) => {
                    currentUser = user;
                    if (user) {
                        document.getElementById('authStatus').innerHTML = `<div class="success">✅ Signed in as: ${user.email || user.phoneNumber}</div>`;
                    } else {
                        document.getElementById('authStatus').innerHTML = '<div>Not signed in</div>';
                    }
                });
            } catch (error) {
                document.getElementById('initStatus').innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        };

        window.signInWithGoogle = async function() {
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                console.log('Google sign-in successful:', result.user);
            } catch (error) {
                document.getElementById('authStatus').innerHTML = `<div class="error">❌ Google sign-in failed: ${error.message}</div>`;
            }
        };

        window.signInWithFacebook = async function() {
            try {
                const provider = new FacebookAuthProvider();
                const result = await signInWithPopup(auth, provider);
                console.log('Facebook sign-in successful:', result.user);
            } catch (error) {
                document.getElementById('authStatus').innerHTML = `<div class="error">❌ Facebook sign-in failed: ${error.message}</div>`;
            }
        };

        window.signInWithPhone = function() {
            const phoneNumber = prompt('Enter phone number (e.g., +1234567890):');
            if (!phoneNumber) return;

            const appVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                'size': 'invisible'
            });

            signInWithPhoneNumber(auth, phoneNumber, appVerifier)
                .then((confirmationResult) => {
                    const code = prompt('Enter SMS code:');
                    return confirmationResult.confirm(code);
                })
                .then((result) => {
                    console.log('Phone sign-in successful:', result.user);
                })
                .catch((error) => {
                    document.getElementById('authStatus').innerHTML = `<div class="error">❌ Phone sign-in failed: ${error.message}</div>`;
                });
        };

        window.getIdToken = async function() {
            if (!currentUser) {
                document.getElementById('tokenDisplay').innerHTML = '<div class="error">❌ Please sign in first</div>';
                document.getElementById('tokenDisplay').style.display = 'block';
                return;
            }

            try {
                const idToken = await currentUser.getIdToken();
                document.getElementById('tokenDisplay').innerHTML = `<strong>ID Token:</strong><br>${idToken}`;
                document.getElementById('tokenDisplay').style.display = 'block';
                window.currentToken = idToken;
            } catch (error) {
                document.getElementById('tokenDisplay').innerHTML = `<div class="error">❌ Error getting token: ${error.message}</div>`;
                document.getElementById('tokenDisplay').style.display = 'block';
            }
        };

        window.copyToken = function() {
            if (window.currentToken) {
                navigator.clipboard.writeText(window.currentToken).then(() => {
                    alert('Token copied to clipboard!');
                });
            } else {
                alert('No token available. Click "Get ID Token" first.');
            }
        };

        window.testBackend = async function() {
            if (!window.currentToken) {
                document.getElementById('backendStatus').innerHTML = '<div class="error">❌ No token available. Get ID token first.</div>';
                return;
            }

            try {
                const response = await fetch('http://localhost:4001/api/auth/firebase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        idToken: window.currentToken
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('backendStatus').innerHTML = `<div class="success">✅ Backend test successful!<br>User: ${result.user.name} (${result.user.email})<br>App Token: ${result.token.substring(0, 50)}...</div>`;
                } else {
                    document.getElementById('backendStatus').innerHTML = `<div class="error">❌ Backend error: ${result.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                document.getElementById('backendStatus').innerHTML = `<div class="error">❌ Network error: ${error.message}</div>`;
            }
        };
    </script>

    <div id="recaptcha-container"></div>
</body>
</html>